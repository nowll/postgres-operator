---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.13.0
  name: postgresinstances.database.example.com
spec:
  group: database.example.com
  names:
    kind: PostgresInstance
    listKind: PostgresInstanceList
    plural: postgresinstances
    shortNames:
      - pgi
    singular: postgresinstance
  scope: Namespaced
  versions:
    - additionalPrinterColumns:
        - jsonPath: .spec.version
          name: Version
          type: string
        - jsonPath: .spec.replicas
          name: Replicas
          type: integer
        - jsonPath: .status.phase
          name: Status
          type: string
        - jsonPath: .metadata.creationTimestamp
          name: Age
          type: date
      name: v1alpha1
      schema:
        openAPIV3Schema:
          description: PostgresInstance is the Schema for the postgresinstances API
          properties:
            apiVersion:
              description:
                "APIVersion defines the versioned schema of this representation
                of an object. Servers should convert recognized schemas to the latest
                internal value, and may reject unrecognized values. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources"
              type: string
            kind:
              description:
                "Kind is a string value representing the REST resource this
                object represents. Servers may infer this from the endpoint the client
                submits requests to. Cannot be updated. In CamelCase. More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds"
              type: string
            metadata:
              type: object
            spec:
              description: PostgresInstanceSpec defines the desired state of PostgresInstance
              properties:
                backup:
                  description: Backup defines the backup configuration
                  properties:
                    enabled:
                      description: Enabled indicates if backups are enabled
                      type: boolean
                    retention:
                      default: 7
                      description: Retention is the number of days to retain backups
                      minimum: 1
                      type: integer
                    s3:
                      description: S3 defines S3 configuration for backups
                      properties:
                        bucket:
                          description: Bucket is the S3 bucket name
                          type: string
                        endpoint:
                          description: Endpoint is the S3 endpoint
                          type: string
                        region:
                          description: Region is the S3 region
                          type: string
                      required:
                        - bucket
                      type: object
                    schedule:
                      description: Schedule is the cron schedule for backups
                      type: string
                  required:
                    - enabled
                  type: object
                databases:
                  description: Databases is a list of databases to create
                  items:
                    description: DatabaseSpec defines a database to create
                    properties:
                      name:
                        description: Name is the database name
                        type: string
                      owner:
                        description: Owner is the database owner
                        type: string
                    required:
                      - name
                    type: object
                  type: array
                replicas:
                  default: 1
                  description: Replicas is the number of PostgreSQL instances
                  maximum: 5
                  minimum: 1
                  type: integer
                resources:
                  description: Resources defines the resource requirements
                  properties:
                    limits:
                      description: Limits describes the maximum resources allowed
                      properties:
                        cpu:
                          description: CPU resource
                          type: string
                        memory:
                          description: Memory resource
                          type: string
                      type: object
                    requests:
                      description: Requests describes the minimum resources required
                      properties:
                        cpu:
                          description: CPU resource
                          type: string
                        memory:
                          description: Memory resource
                          type: string
                      type: object
                  type: object
                storage:
                  description: Storage defines the storage configuration
                  properties:
                    size:
                      description: Size is the storage size
                      pattern: ^[0-9]+Gi$
                      type: string
                    storageClass:
                      description: StorageClass is the storage class name
                      type: string
                  required:
                    - size
                  type: object
                users:
                  description: Users is a list of users to create
                  items:
                    description: UserSpec defines a user to create
                    properties:
                      databases:
                        description:
                          Databases is a list of databases the user has access
                          to
                        items:
                          type: string
                        type: array
                      name:
                        description: Name is the username
                        type: string
                    required:
                      - name
                    type: object
                  type: array
                version:
                  description: Version is the PostgreSQL version to deploy
                  enum:
                    - "14"
                    - "15"
                    - "16"
                  type: string
              required:
                - storage
                - version
              type: object
            status:
              description: PostgresInstanceStatus defines the observed state of PostgresInstance
              properties:
                endpoints:
                  description: Endpoints contains the connection endpoints
                  properties:
                    primary:
                      description: Primary is the primary endpoint
                      type: string
                    replicas:
                      description: Replicas are the replica endpoints
                      items:
                        type: string
                      type: array
                  type: object
                lastBackup:
                  description: LastBackup is the timestamp of the last backup
                  format: date-time
                  type: string
                message:
                  description:
                    Message provides additional information about the current
                    state
                  type: string
                phase:
                  description: Phase is the current phase of the PostgreSQL instance
                  enum:
                    - Pending
                    - Creating
                    - Running
                    - Failed
                    - Upgrading
                  type: string
                ready:
                  description: Ready indicates if the instance is ready
                  type: boolean
              type: object
          type: object
      served: true
      storage: true
      subresources:
        status: {}
